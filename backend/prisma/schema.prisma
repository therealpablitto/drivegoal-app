generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  telegramId String?  @unique @map("telegram_id")
  username   String?
  firstName  String?  @map("first_name")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  goals   Goal[]
  entries Entry[]

  @@map("users")
}

model Goal {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  title       String
  description String?
  deadline    DateTime?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subcategories Subcategory[]
  entries       Entry[]

  @@map("goals")
}

model Subcategory {
  id        String   @id @default(cuid())
  goalId    String   @map("goal_id")
  name      String
  emoji     String   @default("üéØ")
  weight    Float    @default(1.0) // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  color     String   @default("#6366f1")
  createdAt DateTime @default(now()) @map("created_at")

  goal         Goal         @relation(fields: [goalId], references: [id], onDelete: Cascade)
  entryScores  EntryScore[]

  @@map("subcategories")
}

model Entry {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  goalId     String   @map("goal_id")
  rawText    String   @map("raw_text") // –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  date       DateTime @default(now()) @db.Date
  totalScore Float    @default(0) @map("total_score") // –∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª –¥–Ω—è (0-100)
  aiComment  String?  @map("ai_comment") // –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç AI
  createdAt  DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal        Goal         @relation(fields: [goalId], references: [id], onDelete: Cascade)
  entryScores EntryScore[]

  @@unique([userId, goalId, date])
  @@map("entries")
}

model EntryScore {
  id             String   @id @default(cuid())
  entryId        String   @map("entry_id")
  subcategoryId  String   @map("subcategory_id")
  score          Float    // 0-10 –±–∞–ª–ª –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  actions        String[] // –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ AI –≤—ã–¥–µ–ª–∏–ª
  aiComment      String?  @map("ai_comment")
  createdAt      DateTime @default(now()) @map("created_at")

  entry       Entry       @relation(fields: [entryId], references: [id], onDelete: Cascade)
  subcategory Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)

  @@map("entry_scores")
}

// –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∏–∫–æ–≤ –∏ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ ‚Äî –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —Å—á–∏—Ç–∞—Ç—å –∏–∑ entries
model UserStats {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id")
  goalId           String   @map("goal_id")
  currentStreak    Int      @default(0) @map("current_streak")
  longestStreak    Int      @default(0) @map("longest_streak")
  totalScore       Float    @default(0) @map("total_score")
  totalEntries     Int      @default(0) @map("total_entries")
  lastEntryDate    DateTime? @map("last_entry_date") @db.Date
  progressPercent  Float    @default(0) @map("progress_percent")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("user_stats")
}
