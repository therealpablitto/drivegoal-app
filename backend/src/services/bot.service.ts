import { Telegraf } from 'telegraf';

/**
 * Telegram Bot ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
 * –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ long polling (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).
 * –í –ø—Ä–æ–¥–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ webhook.
 */

let bot: Telegraf | null = null;

export function startBot(): void {
  const token = process.env.TELEGRAM_BOT_TOKEN;
  const appUrl = process.env.MINI_APP_URL;

  if (!token) {
    console.log('[Bot] TELEGRAM_BOT_TOKEN not set ‚Äî bot disabled');
    return;
  }

  bot = new Telegraf(token);

  // ‚îÄ‚îÄ /start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  bot.start(async (ctx) => {
    const name = ctx.from.first_name || ctx.from.username || '–¥—Ä—É–≥';

    if (appUrl) {
      // –ï—Å—Ç—å URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Mini App
      await ctx.reply(
        `–ü—Ä–∏–≤–µ—Ç, ${name}! üëã\n\n` +
        `–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –¥–æ–π—Ç–∏ –¥–æ –±–æ–ª—å—à–æ–π —Ü–µ–ª–∏ ‚Äî —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.\n\n` +
        `üöó –ö–æ–ø–∏ –Ω–∞ –º–∞—à–∏–Ω—É, –∫–≤–∞—Ä—Ç–∏—Ä—É, —Å—Ç–∞—Ä—Ç–∞–ø ‚Äî –∏–ª–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é —Ü–µ–ª—å.\n` +
        `ü§ñ AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å.\n\n` +
        `–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å üëá`,
        {
          reply_markup: {
            inline_keyboard: [[
              {
                text: 'üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                web_app: { url: appUrl },
              },
            ]],
          },
        }
      );
    } else {
      // URL –Ω–µ –∑–∞–¥–∞–Ω ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
      await ctx.reply(
        `–ü—Ä–∏–≤–µ—Ç, ${name}! üëã\n\n` +
        `–Ø ‚Äî Drive, —Ç–≤–æ–π AI-—Ç—Ä–µ–∫–µ—Ä –±–æ–ª—å—à–æ–π —Ü–µ–ª–∏.\n\n` +
        `–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â—ë –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞!`
      );
    }
  });

  // ‚îÄ‚îÄ /help ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  bot.help((ctx) => {
    ctx.reply(
      `üìñ <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Drive</b>\n\n` +
      `1. –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π –≤ –º–µ–Ω—é\n` +
      `2. –ü–æ—Å—Ç–∞–≤—å –±–æ–ª—å—à—É—é —Ü–µ–ª—å\n` +
      `3. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–∏—à–∏, —á—Ç–æ —Å–¥–µ–ª–∞–ª\n` +
      `4. AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å\n\n` +
      `üî• –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–π —Å—Ç—Ä–∏–∫ ‚Äî —ç—Ç–æ –≥–ª–∞–≤–Ω—ã–π –º–æ—Ç–∏–≤–∞—Ç–æ—Ä!`,
      { parse_mode: 'HTML' }
    );
  });

  // ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  bot.catch((err) => {
    console.error('[Bot] Error:', err);
  });

  // ‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ long polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: bot.launch() —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è –ø—Ä–∏ –û–°–¢–ê–ù–û–í–ö–ï, –∞ –Ω–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  console.log('[Bot] Starting @DriveGoal_bot (long polling)...');
  bot.launch({ dropPendingUpdates: true })
    .catch((err) => console.error('[Bot] Stopped with error:', err));
  console.log('[Bot] @DriveGoal_bot polling active ‚úÖ');
}
